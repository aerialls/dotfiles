#!/bin/sh

SCRIPT=$0:A
DOTFILES="$(cd "$(dirname $SCRIPT)/.." && pwd)"
HOSTNAME="$(hostname -s)"
HOMEBREW="/usr/local/bin/brew"

HOMEBREW_PACKAGES=(
    'curl'
    'git'
    'git-town'
    'go'
    'ncdu'
    'openssl'
    'p7zip'
    'python'
    'python3'
    'telnet'
)

VSCODE_EXTENSIONS=(
    'PeterJausovec.vscode-docker'
    'lukehoban.Go'
    'CoenraadS.bracket-pair-colorizer'
    'robertohuertasm.vscode-icons'
    'ms-python.python'
)

is_macos () {
    [[ $('uname') == 'Darwin' ]]
}

cd $DOTFILES && git submodule init && git submodule update

if is_macos; then
    if [ ! -x $HOMEBREW ]; then
        # Setup Homebrew
        ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
    fi

    # Basic packages for Homebrew
    for package in "${HOMEBREW_PACKAGES[@]}"; do
        brew install $package &> /dev/null
    done
fi

# Fonts
$DOTFILES/fonts/install.sh &> /dev/null

# Visual Studio Code
ln -nfs $DOTFILES/vscode/settings.json ~/Library/Application\ Support/Code/User/settings.json
ln -nfs $DOTFILES/vscode/locale.json ~/Library/Application\ Support/Code/User/locale.json

# Git
ln -nfs $DOTFILES/git/gitconfig ~/.gitconfig
ln -nfs $DOTFILES/git/gitignore-global ~/.gitignore-global

if [ -f "$DOTFILES/git/gitconfig-$HOSTNAME" ]; then
    ln -nfs $DOTFILES/git/gitconfig-$HOSTNAME ~/.gitconfig-local
fi

# ZSH
ln -nfs $DOTFILES/zsh/zshrc.zsh ~/.zshrc

if is_macos; then
    # iTerm
    defaults write com.googlecode.iterm2 "PrefsCustomFolder" -string "$DOTFILES/iterm"
    defaults write com.googlecode.iterm2 "LoadPrefsFromCustomFolder" -bool true

    # Visual Studio Code extensions
    CODE="/Applications/Visual Studio Code.app/Contents/Resources/app/bin/code"
    for extension in "${VSCODE_EXTENSIONS[@]}"; do
        "$CODE" --install-extension $extension &> /dev/null
    done
fi
